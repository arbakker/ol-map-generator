<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <script type="module">
            import { default as ImageLayer } from 'https://esm.run/ol@6.9.0/src/layer/Image';
import { default as ImageWMS } from 'https://esm.run/ol@6.9.0/src/source/ImageWMS';
import { default as TileLayer } from 'https://esm.run/ol@6.9.0/src/layer/Tile';
import { default as WMTS } from 'https://esm.run/ol@6.9.0/src/source/WMTS';
import { default as WMTSTileGrid } from 'https://esm.run/ol@6.9.0/src/tilegrid/WMTS';
import { get as getProjection } from 'https://esm.run/ol@6.9.0/src/proj';
import { getTopLeft, getWidth } from 'https://esm.run/ol@6.9.0/src/extent';
import { Circle as CircleStyle, Fill, Stroke, Style, Text, Icon } from 'https://esm.run/ol@6.9.0/src/style';
import { default as Map } from 'https://esm.run/ol@6.9.0/src/Map';
import GeoJSON from 'https://esm.run/ol@6.9.0/src/format/GeoJSON';
import { default as VectorSource } from 'https://esm.run/ol@6.9.0/src/source/Vector';
import { default as VectorLayer } from 'https://esm.run/ol@6.9.0/src/layer/Vector';
import 'https://esm.run/mustache@4.2.0/mustache.js';

let config={"title":"My Cool Generated Map!","constrainBoundsEnabled":false,"lsControlEnabled":true,"layers":[{"serviceType":"WMTS","serviceUrl":"https://service.pdok.nl/hwh/luchtfotorgb/wms/v1_0","layerName":"2021_quick_orthoHR","opacity":0.5,"grayscale":1,"layerType":"serviceLayer","title":"Layer 2"},{"source":"https://service.pdok.nl/kadaster/bestuurlijkegebieden/wfs/v1_0?request=GetFeature&service=WFS&version=2.0.0&outputFormat=application/json&srsname=EPSG:4326&startIndex=0&count=20&typename=bestuurlijkegebieden:Gemeentegebied&bbox=181490.21037169415,426974.7956999999,203370.53037169416,462160.71569999994,EPSG:28992","color":[18,39,58],"width":3,"stroke":[1,6,1,6],"layerType":"featureLayer","labels":false,"labelProperty":"naam","title":"Layer 1","opacity":1,"grayscale":0,"hexColor":"12273aff","geomType":"Polygon"},{"color":[18,39,58],"title":"Layer 3","opacity":1,"labels":false,"labelProperty":"label","icon":"airport","iconSize":3,"layerType":"featureLayer","source":{"type":"FeatureCollection","name":"punten","features":[{"type":"Feature","properties":{"label":"muziekmachine"},"geometry":{"type":"Point","coordinates":[5.9149526,51.9784253]}},{"type":"Feature","properties":{"label":"deviezentekort"},"geometry":{"type":"Point","coordinates":[5.9032386,51.9832629]}},{"type":"Feature","properties":{"label":"hoornblazer"},"geometry":{"type":"Point","coordinates":[5.8936242,51.9726268]}},{"type":"Feature","properties":{"label":"omzetontwikkelingen"},"geometry":{"type":"Point","coordinates":[5.9051535,51.9687181]}},{"type":"Feature","properties":{"label":"configuraties"},"geometry":{"type":"Point","coordinates":[5.9076766,51.9816731]}},{"type":"Feature","properties":{"label":"bereisbaar"},"geometry":{"type":"Point","coordinates":[5.9183032,51.9873309]}},{"type":"Feature","properties":{"label":"huisstofmijten"},"geometry":{"type":"Point","coordinates":[5.9119014,51.9898272]}},{"type":"Feature","properties":{"label":"non-events"},"geometry":{"type":"Point","coordinates":[5.8933674,51.9552351]}},{"type":"Feature","properties":{"label":"bezeert"},"geometry":{"type":"Point","coordinates":[5.8787953,51.9507506]}},{"type":"Feature","properties":{"label":"historiek"},"geometry":{"type":"Point","coordinates":[5.8788695,51.9663634]}},{"type":"Feature","properties":{"label":"morsebel"},"geometry":{"type":"Point","coordinates":[5.8897616,51.966108]}},{"type":"Feature","properties":{"label":"instrumentenbouwers"},"geometry":{"type":"Point","coordinates":[5.9306353,51.9565941]}},{"type":"Feature","properties":{"label":"toevloeiden"},"geometry":{"type":"Point","coordinates":[5.9542404,51.970361]}},{"type":"Feature","properties":{"label":"vaccineerde"},"geometry":{"type":"Point","coordinates":[5.9321758,51.9797974]}},{"type":"Feature","properties":{"label":"bevallingsverhaal"},"geometry":{"type":"Point","coordinates":[5.8710351,51.9964555]}}]},"grayscale":0,"hexColor":"12273aff","geomType":"Point","svgIcon":"<?xml version=\"1.0\" encoding=\"UTF-8\"?><svg version=\"1.1\" id=\"airport\" xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"-2 -2 19 19\">  <path stroke=\"#ffffffCC\" stroke-width=\"2px\" id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/><path id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/></svg>"}],"location":{"x":674103.0693749136,"y":6778624.803135729,"z":11},"generator":false,"layersString":["{\"serviceType\":\"WMTS\",\"serviceUrl\":\"https://service.pdok.nl/hwh/luchtfotorgb/wms/v1_0\",\"layerName\":\"2021_quick_orthoHR\",\"opacity\":0.5,\"grayscale\":1,\"layerType\":\"serviceLayer\",\"title\":\"Layer 2\"}","{\"source\":\"https://service.pdok.nl/kadaster/bestuurlijkegebieden/wfs/v1_0?request=GetFeature&service=WFS&version=2.0.0&outputFormat=application/json&srsname=EPSG:4326&startIndex=0&count=20&typename=bestuurlijkegebieden:Gemeentegebied&bbox=181490.21037169415,426974.7956999999,203370.53037169416,462160.71569999994,EPSG:28992\",\"color\":[18,39,58],\"width\":3,\"stroke\":[1,6,1,6],\"layerType\":\"featureLayer\",\"labels\":false,\"labelProperty\":\"naam\",\"title\":\"Layer 1\",\"opacity\":1,\"grayscale\":0,\"hexColor\":\"12273aff\",\"geomType\":\"Polygon\"}","{\"color\":[18,39,58],\"title\":\"Layer 3\",\"opacity\":1,\"labels\":false,\"labelProperty\":\"label\",\"icon\":\"airport\",\"iconSize\":3,\"layerType\":\"featureLayer\",\"source\":{\"type\":\"FeatureCollection\",\"name\":\"punten\",\"features\":[{\"type\":\"Feature\",\"properties\":{\"label\":\"muziekmachine\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9149526,51.9784253]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"deviezentekort\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9032386,51.9832629]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"hoornblazer\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8936242,51.9726268]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"omzetontwikkelingen\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9051535,51.9687181]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"configuraties\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9076766,51.9816731]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"bereisbaar\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9183032,51.9873309]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"huisstofmijten\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9119014,51.9898272]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"non-events\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8933674,51.9552351]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"bezeert\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8787953,51.9507506]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"historiek\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8788695,51.9663634]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"morsebel\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8897616,51.966108]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"instrumentenbouwers\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9306353,51.9565941]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"toevloeiden\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9542404,51.970361]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"vaccineerde\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.9321758,51.9797974]}},{\"type\":\"Feature\",\"properties\":{\"label\":\"bevallingsverhaal\"},\"geometry\":{\"type\":\"Point\",\"coordinates\":[5.8710351,51.9964555]}}]},\"grayscale\":0,\"hexColor\":\"12273aff\",\"geomType\":\"Point\",\"svgIcon\":\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?><svg version=\\\"1.1\\\" id=\\\"airport\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"15\\\" height=\\\"15\\\" viewBox=\\\"-2 -2 19 19\\\">  <path stroke=\\\"#ffffffCC\\\" stroke-width=\\\"2px\\\" id=\\\"path7712-0\\\" d=\\\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\\\"/><path id=\\\"path7712-0\\\" d=\\\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\\\"/></svg>\"}"]}

var map
if (config.generator){
    console.log("generator", config)
    this.$refs["map-root"].innerHTML =''
    map = new Map({
    target: this.$refs["map-root"],
    })
}else{
    map = new Map({
    target: "map"
    })
}

function lineStyle(config) {
    let colorString = `rgb(${config.color[0]},${config.color[1]},${config.color[2]})`;
    let dash = getDash(config);
    return {
    stroke: new Stroke({
        ...{
        color: colorString,
        width: config.width,
        },
        ...dash,
    }),
    };
}

function pointStyle(config) {
    // replace 2nd occurence in SVG - first path occurence is for white bg halo - https://stackoverflow.com/a/44568739
    // TOOD: maybe move to generator code
    let scale = 1.5;
    if ("iconSize" in config) {
    scale = config.iconSize;
    }
    let i = 0;
    let icon = config.svgIcon.replace(/<path/g, (match) =>
    ++i === 2 ? `<path fill="#${config.hexColor}"` : match
    );
    const src = "data:image/svg+xml;utf8," + escape(icon);
    return {
    image: new Icon({
        opacity: 1,
        src: src,
        scale: scale,
    }),
    };
}

function getDash(config) {
    const dashDic = {
    dashed: {
        lineDash: [4],
    },
    solid: {},
    dotted: {
        lineDash: [1, 4, 1, 4],
    },
    "dash-dotted": {
        lineDash: [9, 3, 3, 3],
    },
    };
    let dash;
    if (!Array.isArray(config.stroke)) {
    dash =
        config.stroke in dashDic
        ? dashDic[config.stroke]
        : dashDic["solid"];
    } else {
    dash = {
        lineDash: config.stroke,
    };
    }
    return dash;
}

function polygonStyle(config) {
    // TODO: fix default colors in generator code
    let colorString = `rgb(${config.color[0]},${config.color[1]},${config.color[2]})`;
    let fillColor = `rgba(${config.color[0]},${config.color[1]},${config.color[2]},0.2)`;
    if (!("stroke" in config)) {
    config.stroke = "dashed";
    }
    if (!("width" in config)) {
    config.width = 2;
    }
    let dash = getDash(config);
    return {
    stroke: new Stroke({
        ...{
        color: colorString,
        width: config.width,
        },
        ...dash,
    }),
    fill: new Fill({
        color: fillColor,
    }),
    };
}

function getStyle(config) {
    console.log(config.geomType)
    const styles = {
    Point: pointStyle,
    LineString: lineStyle,
    Polygon: polygonStyle,
    };
    let style = styles[config.geomType];
    if (
    typeof config.color === "string" &&
    config.color.split(",").length > 2
    ) {
    config.color = config.color.split(",");
    }
    return style(config);
}

function getStyleFunction(config) {
    // eslint-disable-next-line no-unused-vars
    return function (feature, resolution) {
    let symbolStyle = getStyle(config);
    if ("labels" in config && config.labels) {
        const placementDic = {
        Point: {
            offsetX: 7,
            offsetY: -7,
            textAlign: "start",
            overflow: true,
        },
        Polygon: {
            textAlign: "center",
            overflow: true,
        },
        LineString: {
            offsetX: 6,
            offsetY: -6,
            textAlign: "start",
        },
        };
        let textStyle = {
        text: new Text({
            ...{
            text: feature.get(config.labelProperty),
            scale: 1.3,
            fill: new Fill({
                color: "#000000",
            }),
            stroke: new Stroke({
                color: "rgba(255, 255, 255, 0.8)",
                width: 3,
            }),
            },
            ...placementDic[config.geomType],
        }),
        };
        return new Style({
        ...textStyle,
        ...symbolStyle,
        });
    }
    return new Style(symbolStyle);
    };
}

function isValidHttpUrl(string) {
    let url;
    try {
    url = new URL(string);
    } catch (_) {
    return false;
    }

    return url.protocol === "http:" || url.protocol === "https:";
}

const projection = getProjection("EPSG:3857");
const projectionExtent = projection.getExtent();
const size = getWidth(projectionExtent) / 256;
const resolutions = new Array(19);
const matrixIds = new Array(19);
for (let z = 0; z < 19; ++z) {
    // generate resolutions and matrixIds arrays for this WMTS
    resolutions[z] = size / Math.pow(2, z);
    matrixIds[z] = z;
}

async function getResourceText(filename) {
    let response = await fetch(filename);
    if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
    }
    return await response.text();
}
// eslint-disable-next-line no-unused-vars
async function getFeatureData(config) {
    if (config.layerType === "featureLayer") {
    let ftCollection;
    if (isValidHttpUrl(config.source)) {
        let ftCollectionString = await getResourceText(config.source);
        ftCollection = JSON.parse(ftCollectionString);
    } else {
        ftCollection = config.source;
    }
    return { ftCollection: ftCollection, config: config };
    } else {
    // optionally retrieve metadata from service
    return { serviceUrl: config.serviceUrl, config: config };
    }
}

function postRender(evt) {
    let grayscale = evt.target.get("grayscale");
    evt.context.globalCompositeOperation = "color";
    if (evt.context.globalCompositeOperation === "color") {
    // operation is supported by browser
    evt.context.fillStyle = "rgba(255,255,255," + grayscale + ")";
    evt.context.fillRect(
        0,
        0,
        evt.context.canvas.width,
        evt.context.canvas.height
    );
    }
    evt.context.globalCompositeOperation = "source-over";
}

const promises = [];

if (!config.generator){
    // REMOVE THIS IF BLOCK IN VUEJS APP WHEN COPYING OVER CODE ONLY KEEP ELSE
    promises.push(
        getFeatureData(
            {"serviceType":"WMTS","serviceUrl":"https://service.pdok.nl/hwh/luchtfotorgb/wms/v1_0","layerName":"2021_quick_orthoHR","opacity":0.5,"grayscale":1,"layerType":"serviceLayer","title":"Layer 2"}    
        )
    )
    promises.push(
        getFeatureData(
            {"source":"https://service.pdok.nl/kadaster/bestuurlijkegebieden/wfs/v1_0?request=GetFeature&service=WFS&version=2.0.0&outputFormat=application/json&srsname=EPSG:4326&startIndex=0&count=20&typename=bestuurlijkegebieden:Gemeentegebied&bbox=181490.21037169415,426974.7956999999,203370.53037169416,462160.71569999994,EPSG:28992","color":[18,39,58],"width":3,"stroke":[1,6,1,6],"layerType":"featureLayer","labels":false,"labelProperty":"naam","title":"Layer 1","opacity":1,"grayscale":0,"hexColor":"12273aff","geomType":"Polygon"}    
        )
    )
    promises.push(
        getFeatureData(
            {"color":[18,39,58],"title":"Layer 3","opacity":1,"labels":false,"labelProperty":"label","icon":"airport","iconSize":3,"layerType":"featureLayer","source":{"type":"FeatureCollection","name":"punten","features":[{"type":"Feature","properties":{"label":"muziekmachine"},"geometry":{"type":"Point","coordinates":[5.9149526,51.9784253]}},{"type":"Feature","properties":{"label":"deviezentekort"},"geometry":{"type":"Point","coordinates":[5.9032386,51.9832629]}},{"type":"Feature","properties":{"label":"hoornblazer"},"geometry":{"type":"Point","coordinates":[5.8936242,51.9726268]}},{"type":"Feature","properties":{"label":"omzetontwikkelingen"},"geometry":{"type":"Point","coordinates":[5.9051535,51.9687181]}},{"type":"Feature","properties":{"label":"configuraties"},"geometry":{"type":"Point","coordinates":[5.9076766,51.9816731]}},{"type":"Feature","properties":{"label":"bereisbaar"},"geometry":{"type":"Point","coordinates":[5.9183032,51.9873309]}},{"type":"Feature","properties":{"label":"huisstofmijten"},"geometry":{"type":"Point","coordinates":[5.9119014,51.9898272]}},{"type":"Feature","properties":{"label":"non-events"},"geometry":{"type":"Point","coordinates":[5.8933674,51.9552351]}},{"type":"Feature","properties":{"label":"bezeert"},"geometry":{"type":"Point","coordinates":[5.8787953,51.9507506]}},{"type":"Feature","properties":{"label":"historiek"},"geometry":{"type":"Point","coordinates":[5.8788695,51.9663634]}},{"type":"Feature","properties":{"label":"morsebel"},"geometry":{"type":"Point","coordinates":[5.8897616,51.966108]}},{"type":"Feature","properties":{"label":"instrumentenbouwers"},"geometry":{"type":"Point","coordinates":[5.9306353,51.9565941]}},{"type":"Feature","properties":{"label":"toevloeiden"},"geometry":{"type":"Point","coordinates":[5.9542404,51.970361]}},{"type":"Feature","properties":{"label":"vaccineerde"},"geometry":{"type":"Point","coordinates":[5.9321758,51.9797974]}},{"type":"Feature","properties":{"label":"bevallingsverhaal"},"geometry":{"type":"Point","coordinates":[5.8710351,51.9964555]}}]},"grayscale":0,"hexColor":"12273aff","geomType":"Point","svgIcon":"<?xml version=\"1.0\" encoding=\"UTF-8\"?><svg version=\"1.1\" id=\"airport\" xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"-2 -2 19 19\">  <path stroke=\"#ffffffCC\" stroke-width=\"2px\" id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/><path id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/></svg>"}    
        )
    )
}else{
    config.layersString = config.layers.map(x=> JSON.stringify(x))
    let template = `
    promises.push(
        getFeatureData(
            {"serviceType":"WMTS","serviceUrl":"https://service.pdok.nl/hwh/luchtfotorgb/wms/v1_0","layerName":"2021_quick_orthoHR","opacity":0.5,"grayscale":1,"layerType":"serviceLayer","title":"Layer 2"}    
        )
    )
        promises.push(
        getFeatureData(
            {"source":"https://service.pdok.nl/kadaster/bestuurlijkegebieden/wfs/v1_0?request=GetFeature&service=WFS&version=2.0.0&outputFormat=application/json&srsname=EPSG:4326&startIndex=0&count=20&typename=bestuurlijkegebieden:Gemeentegebied&bbox=181490.21037169415,426974.7956999999,203370.53037169416,462160.71569999994,EPSG:28992","color":[18,39,58],"width":3,"stroke":[1,6,1,6],"layerType":"featureLayer","labels":false,"labelProperty":"naam","title":"Layer 1","opacity":1,"grayscale":0,"hexColor":"12273aff","geomType":"Polygon"}    
        )
    )
        promises.push(
        getFeatureData(
            {"color":[18,39,58],"title":"Layer 3","opacity":1,"labels":false,"labelProperty":"label","icon":"airport","iconSize":3,"layerType":"featureLayer","source":{"type":"FeatureCollection","name":"punten","features":[{"type":"Feature","properties":{"label":"muziekmachine"},"geometry":{"type":"Point","coordinates":[5.9149526,51.9784253]}},{"type":"Feature","properties":{"label":"deviezentekort"},"geometry":{"type":"Point","coordinates":[5.9032386,51.9832629]}},{"type":"Feature","properties":{"label":"hoornblazer"},"geometry":{"type":"Point","coordinates":[5.8936242,51.9726268]}},{"type":"Feature","properties":{"label":"omzetontwikkelingen"},"geometry":{"type":"Point","coordinates":[5.9051535,51.9687181]}},{"type":"Feature","properties":{"label":"configuraties"},"geometry":{"type":"Point","coordinates":[5.9076766,51.9816731]}},{"type":"Feature","properties":{"label":"bereisbaar"},"geometry":{"type":"Point","coordinates":[5.9183032,51.9873309]}},{"type":"Feature","properties":{"label":"huisstofmijten"},"geometry":{"type":"Point","coordinates":[5.9119014,51.9898272]}},{"type":"Feature","properties":{"label":"non-events"},"geometry":{"type":"Point","coordinates":[5.8933674,51.9552351]}},{"type":"Feature","properties":{"label":"bezeert"},"geometry":{"type":"Point","coordinates":[5.8787953,51.9507506]}},{"type":"Feature","properties":{"label":"historiek"},"geometry":{"type":"Point","coordinates":[5.8788695,51.9663634]}},{"type":"Feature","properties":{"label":"morsebel"},"geometry":{"type":"Point","coordinates":[5.8897616,51.966108]}},{"type":"Feature","properties":{"label":"instrumentenbouwers"},"geometry":{"type":"Point","coordinates":[5.9306353,51.9565941]}},{"type":"Feature","properties":{"label":"toevloeiden"},"geometry":{"type":"Point","coordinates":[5.9542404,51.970361]}},{"type":"Feature","properties":{"label":"vaccineerde"},"geometry":{"type":"Point","coordinates":[5.9321758,51.9797974]}},{"type":"Feature","properties":{"label":"bevallingsverhaal"},"geometry":{"type":"Point","coordinates":[5.8710351,51.9964555]}}]},"grayscale":0,"hexColor":"12273aff","geomType":"Point","svgIcon":"<?xml version=\"1.0\" encoding=\"UTF-8\"?><svg version=\"1.1\" id=\"airport\" xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"-2 -2 19 19\">  <path stroke=\"#ffffffCC\" stroke-width=\"2px\" id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/><path id=\"path7712-0\" d=\"M15,6.8182L15,8.5l-6.5-1&#xA;&#x9;l-0.3182,4.7727L11,14v1l-3.5-0.6818L4,15v-1l2.8182-1.7273L6.5,7.5L0,8.5V6.8182L6.5,4.5v-3c0,0,0-1.5,1-1.5s1,1.5,1,1.5v2.8182&#xA;&#x9;L15,6.8182z\"/></svg>"}    
        )
    )
    `;
    let promisesJS = Mustache.render(template, config);
    eval(promisesJS);
}


const layers = [];
// resolve promises with all to maintain layer order
Promise.all(promises).then((values) => {
    values.forEach((result) => {
    if (result.config.layerType === "featureLayer") {
        layers.push(
        new VectorLayer({
            declutter: true,
            source: new VectorSource({
            features: new GeoJSON({
                featureProjection: "EPSG:3857",
            }).readFeatures(result.ftCollection),
            }),
            style: getStyleFunction(result.config),
            opacity: result.config.opacity,
        })
        );
    } else if (result.config.layerType === "serviceLayer") {
        if (result.config.serviceType === "WMS") {
        layers.push(
            new ImageLayer({
            source: new ImageWMS({
                url: result.config.serviceUrl,
                params: { LAYERS: result.config.layerName }, // TODO: add style parameter
                ratio: 1,
            }),
            ...("grayscale" in result.config && {
                grayscale: result.config.grayscale,
            }), // add property conditionally
            ...("opacity" in result.config && {
                opacity: result.config.opacity,
            }),
            })
        );
        } else if (result.config.serviceType === "WMTS") {
        layers.push(
            new TileLayer({
            source: new WMTS({
                url: result.config.serviceUrl,
                layer: result.config.layerName,
                matrixSet: "EPSG:3857",
                format: "image/png",
                projection: projection,
                tileGrid: new WMTSTileGrid({
                origin: getTopLeft(projectionExtent),
                resolutions: resolutions,
                matrixIds: matrixIds,
                }),
                style: "default",
                wrapX: true,
            }),
            ...("grayscale" in result.config && {
                grayscale: result.config.grayscale,
            }), // add property conditionally
            ...("opacity" in result.config && {
                opacity: result.config.opacity,
            }),
            })
        );
        }
    }
    });
    map.setLayers(layers);
    map.getLayers().forEach((lyr) => {
    let grayscale = lyr.get("grayscale");
    if (grayscale > 0) {
        lyr.on("postrender", postRender);
    }
    });
    map.render()
    // TODO: improve; assuming this executes after end of this function, might be race condition
    if (config.generator){
        this.map = map
        this.map.on('moveend', () => {
            this.updateMapState()
        })
    }
});
// promise returning viewOptions is expected instead of View object https://openlayers.org/en/latest/apidoc/module-ol_Map-Map.html#setView
let viewConfigTemplate = `
{
    "center": [564457.4160, 6783258.6045],
    "zoom": 7
}
`;
let viewConfig = JSON.parse(Mustache.render(viewConfigTemplate, config))
// eslint-disable-next-line no-unused-vars
const viewOptions = new Promise((resolve, reject) => {
    resolve( viewConfig );
});

let constrainBoundsTemplate = 
``
let constrainSet = Mustache.render(constrainBoundsTemplate, config)
eval(constrainSet)
map.setView(viewOptions);




        </script>
    </head>
    <body>
        <div id="map" class="map"></div>
        <link href="https://cdn.jsdelivr.net/npm/ol@6.9.0/ol.css" rel="stylesheet">
        <style>
            @import url(https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400italic,700);
            body {
                margin: unset;
                font-family: 'Quattrocento Sans', sans-serif;
                font-size: 16px;
            }
            .map {
                width: 100vw;
                height: 100vh;
                z-index: 0;
            }
            #mapTitle {
                position: absolute;
                left: 1em;
                bottom: 1em;
                background-color: #ffffffba;
                padding: 0.5em;
            }
        </style>
    </body>
</html>
